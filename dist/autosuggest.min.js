var AutoSuggest=function(e){var t={minInputLen:2,ajaxType:"json",row:5};var n;var r;var i={BACKSPACE:8,ARROWUP:38,ARROWDOWN:40,TAB:9,ENTER:13};var s=function(e){var t=n.val();r.css({position:"relative"});o();var i=[];var s;var u;var a;e.forEach(function(e){if((typeof e).toLowerCase()=="object"){s=e.display;u=e.param;a=e.menuitem}else{s=e;u=e}i.push('<li><a data-keydown="walkSuggestMenu" data-action="pickItem" data-display="'+s+'" href="#" data-param="'+escape(u?u:"")+'">'+a+"</a></li>")});var f=i.join("");r.children(".dropdown-menu").append($(f))};var o=function(){if(r.children(".dropdown-menu").length){r.children(".dropdown-menu").empty()}else{r.append($('<ul id="suggestMenu" class="dropdown-menu" role="menu"></ul>'));setTimeout(function(){r.children(".dropdown-menu").show()},0)}};var u=function(){if(r.children(".dropdown-menu").length){r.children(".dropdown-menu").remove()}};var a={fetchData:function(e,n){var o=$(e.target);var a=e.keyCode;var f=o.data("picked");if(a==i.BACKSPACE&&f){o.val("");o.attr("former-value","");o.data("picked","");return false}if(a==i.ARROWUP||a==i.ARROWDOWN){var l;if(a==i.ARROWUP){l=r.find(".dropdown-menu").length&&r.find(".dropdown-menu a:last").addClass("focus").focus().data("display")||""}if(a==i.ARROWDOWN){l=r.find(".dropdown-menu").length&&r.find(".dropdown-menu a:first").addClass("focus").focus().data("display")||""}if(l)o.val(l);return false}if(a==i.ENTER){r.find(".dropdown-menu").length&&r.find("a[data-keydown]:first").click();return false}var c=o.val();var h=o.attr("former-value");if(c==h){return false}else{o.attr("former-value",c)}console.log(c);if(c.length>t.minInputLen){if(t.dataType=="script"||t.dataType=="json"){url=t.url.replace("{%input%}",c);$.ajax(url,{cache:false,dataType:t.dataType,success:function(e){if(typeof t.processData=="function"){e=t.processData(c,e)}if(typeof e=="object"&&e.length){e=e.splice(0,t.row);s(e)}else{u()}}})}else{throw"无效的 ajaxType 参数。"}}else{u()}},walkSuggestMenu:function(e,t){if(e)e.preventDefault();var r=e.keyCode;if(r==i.TAB||r==i.ENTER){$(e.target).click()}else{var s=$(e.target).parents("ul");var o=s.find("a[data-keydown]");var u=newIndex=o.index(s.find("a.focus"));var a=o.length;if(r==i.ARROWUP){newIndex=u-1<0?a-1:u-1}if(r==i.ARROWDOWN){newIndex=u+1==a?0:u+1}$(o[u]).removeClass("focus");$(o[newIndex]).addClass("focus").focus();n.val($(o[newIndex]).data("display"))}return false},pickItem:function(e,r){var i=e.currentTarget;$(i).parent().addClass("active");setTimeout(function(){u(i);n.val($(i).data("display")).data("picked","1");$ele.focus();if(typeof t.pick=="function"){t.pick(r)}},75)}};t=$.extend({},t,e);$ele=$(t.id).length?$(t.id):$("#"+t.id);if($ele.length==0){throw"指定的元素不存在。"}n=$ele;r=$(t.container).length?$(t.container):$ele.parent();r.delegate("[data-action]","click",function(e){var t=$(this).data("action");var n=$(this).data("param");a[t](e,n)});r.delegate("[data-keydown]","keydown",function(e){var t=$(this).data("keydown");var n=$(this).data("param");a[t](e,n)});r.delegate("[data-keyup]","keyup",function(e){var t=$(this).data("keyup");var n=$(this).data("param");a[t](e,n)})}